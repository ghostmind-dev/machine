name: live
on:
  push:
    branches:
      - main
    paths: 
      - 'users/state/**'      
env:
  SRC: ${{github.workspace}}
  GH_TOKEN: "${{ secrets.GH_TOKEN }}"
  VAULT_ROOT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
  VAULT_ADDR: ${{ secrets.VAULT_ADDR}}
jobs:
  live:
    runs-on: ubuntu-latest
    steps:
      - name: run git safe.directory
        if: ${{ github.event.inputs.LOCAL == 'true' }}
        run: git config --global --add safe.directory "*"
      - name: "check github repository"
        uses: actions/checkout@v3
      - uses: denoland/setup-deno@v1
        with:
          deno-version: canary
      - name: "Install run utils"
        uses: ghostmind-dev/play@main
        with:
          dev: ${{ github.event.inputs.LOCAL == 'true' }}
      - name: set environment
        run: |-
          run action env set
      - name: "install vault cmd"
        run: |-
          sudo apt install -y gpg
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg >/dev/null
          gpg --no-default-keyring --keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg --fingerprint
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update
          sudo apt-get install --reinstall -y vault
          sudo chown root:root /usr/bin/vault
      - name: "login to vault"
        env:
          VAULT_ROOT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR}}
        run: vault login "$VAULT_ROOT_TOKEN" -address="$VAULT_ADDR" -non-interactive=true
      - name: "set global secrets"
        id: global-secrets
        run: run action secrets set --global
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"
      - name: "set up gcloud credentials"
        run: |-
          echo ${GCP_SERVICE_ACCOUNT_ADMIN} | base64 -di -w 0 >/tmp/gsa_key.json
          gcloud auth activate-service-account --key-file="/tmp/gsa_key.json"
          gcloud config set project $GCP_PROJECT_NAME
          gcloud config set compute/zone us-central1-b
          gcloud auth configure-docker gcr.io --quiet
      - name: "terraform installation"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.7
      - name: "authenticate gcr.io to docker"
        run: gcloud --quiet auth configure-docker gcr.io --quiet
      - name: install hasura
        run: curl -L https://github.com/hasura/graphql-engine/raw/stable/cli/get.sh | bash
      - name: "deploy app"
        working-directory: "${{env.SRC}}/app/state"
        run: |-
          run action secrets set
          run custom init

      